<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ginto Terminal</title>
  <link rel="icon" type="image/png" href="/static/favicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
  <style>
    :root{
      --bg:#0b1020;
      --panel:#151f36;
      --panel-2:#1e2a44;
      --text:#e6eef8;
      --muted:#9fb0c8;
      --accent:#3b82f6;
      --ok:#4caf50;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
    .app{height:100%;display:flex;flex-direction:column}
    .topbar{height:56px;display:flex;align-items:center;gap:10px;padding:0 14px;background:#111933;border-bottom:1px solid rgba(255,255,255,0.08)}
    .title{display:flex;align-items:center;gap:10px;font-size:30px;font-weight:700}
    .title small{font-size:18px;font-weight:500;color:var(--muted)}
    .grow{flex:1}
    button{border:none;border-radius:10px;padding:9px 14px;font-weight:600;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--accent),#7c3aed)}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.18);color:var(--text)}
    .terminal-bar{height:52px;display:flex;align-items:center;gap:8px;padding:0 12px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.08)}
    .tab{display:flex;align-items:center;gap:8px;min-width:140px;padding:10px 12px;border-radius:9px;background:var(--panel-2);border:1px solid rgba(255,255,255,0.08);color:var(--text)}
    .status{margin-left:auto;display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.3);color:#9af1a0;font-size:14px}
    #terminalWrap{flex:1;min-height:0;padding:0;background:#050a17}
    #terminal{height:100%;width:100%}
    .xterm-viewport::-webkit-scrollbar{width:10px}
    .xterm-viewport::-webkit-scrollbar-thumb{background:#2b3f66;border-radius:8px}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">⌁ <small>Console</small></div>
      <div class="grow"></div>
      <button id="reconnectBtn">Reconnect</button>
      <button id="closeBtn" class="ghost" title="Back to dashboard">✕</button>
    </div>
    <div class="terminal-bar">
      <div class="tab">Terminal 1</div>
      <span id="connStatus" class="status">Connected</span>
    </div>
    <div id="terminalWrap">
      <div id="terminal"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script>
    let socket = null;
    let terminal = null;
    let fitAddon = null;

    function setStatus(text, connected){
      const badge = document.getElementById('connStatus');
      if(!badge) return;
      badge.textContent = text;
      badge.style.background = connected ? 'rgba(76,175,80,0.2)' : 'rgba(239,68,68,0.2)';
      badge.style.borderColor = connected ? 'rgba(76,175,80,0.3)' : 'rgba(239,68,68,0.32)';
      badge.style.color = connected ? '#9af1a0' : '#fca5a5';
    }

    function wsUrl(){
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      return `${proto}://${location.host}/ws/terminal`;
    }

    function sendResize(){
      if(!socket || socket.readyState !== WebSocket.OPEN || !terminal) return;
      socket.send(JSON.stringify({ type:'resize', cols: terminal.cols, rows: terminal.rows }));
    }

    function initTerminal(){
      terminal = new Terminal({
        convertEol: true,
        cursorBlink: true,
        fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',
        fontSize: 15,
        lineHeight: 1.2,
        theme: {
          background: '#050a17',
          foreground: '#dbe7ff',
          cursor: '#8fb3ff'
        }
      });
      fitAddon = new FitAddon.FitAddon();
      terminal.loadAddon(fitAddon);
      terminal.open(document.getElementById('terminal'));
      fitAddon.fit();

      window.addEventListener('resize', ()=>{
        fitAddon.fit();
        sendResize();
      });

      terminal.onData((data)=>{
        if(socket && socket.readyState === WebSocket.OPEN){
          socket.send(JSON.stringify({ type:'input', data }));
        }
      });
    }

    function connect(){
      if(socket && socket.readyState === WebSocket.OPEN){
        socket.close();
      }
      setStatus('Connecting...', false);
      socket = new WebSocket(wsUrl());
      socket.onopen = ()=>{
        setStatus('Connected', true);
        fitAddon.fit();
        sendResize();
      };
      socket.onmessage = (event)=>{
        terminal.write(event.data || '');
      };
      socket.onclose = ()=>{
        setStatus('Disconnected', false);
      };
      socket.onerror = ()=>{
        setStatus('Connection error', false);
      };
    }

    document.getElementById('reconnectBtn').onclick = ()=>{
      terminal.write('\r\n\x1b[33m[reconnecting]\x1b[0m\r\n');
      connect();
    };

    document.getElementById('closeBtn').onclick = ()=>{
      window.location.href = '/';
    };

    initTerminal();
    connect();
  </script>
</body>
</html>
